name: scan-kong-gateway

on:
  workflow_dispatch:
    inputs:
      tags:
        description: "ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã‚¿ã‚° (ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Š, ä¾‹: 3.10,3.11)"
        required: false
        default: "3.11"
      severity_cutoff:
        description: "Trivy ã®å¤±æ•—é–¾å€¤ (ä¾‹: HIGH,CRITICAL)"
        required: false
        default: "HIGH,CRITICAL"

env:
  BASE_IMAGE_REPO: kong/kong-gateway
  TRIVY_CACHE_DIR: .trivycache
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: kong-gateway-mirror
  TRIVY_VERSION: 0.54.1

permissions:
  contents: read
  security-events: write
  id-token: write

jobs:
  trivy-scan:
    name: Trivy Scan + Mirror
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Normalize tags input
        id: tags
        run: |
          INPUT="${{ github.event.inputs.tags || '3.11' }}"
          LIST=$(echo "$INPUT" | tr ',' '\n' | sed 's/ //g' | grep -v '^$' | sort -u | paste -sd ' ')
          echo "TAGS=$LIST" >> "$GITHUB_ENV"
          echo "Normalized tags: $LIST"

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’Trivyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¿®æ­£ã—ã€ã‚ˆã‚Šé©åˆ‡ã«ã—ã¾ã—ãŸ
      - name: Setup Trivy Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: trivy-${{ runner.os }}-${{ env.TRIVY_VERSION }}
          restore-keys: |
            trivy-${{ runner.os }}-

      - name: Install Trivy CLI
        run: |
          set -euo pipefail
          echo "Installing Trivy ${TRIVY_VERSION}"
          curl -sSL -o trivy.tgz "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz"
          tar zxvf trivy.tgz trivy >/dev/null 2>&1
          sudo mv trivy /usr/local/bin/
          trivy --version

      - name: Validate AWS role secret (enable scan-only fallback)
        id: aws-role-check
        run: |
          if [ -z "${{ secrets.AWS_ROLE_TO_ASSUME }}" ]; then
            echo "AWS_ROLE_TO_ASSUME secret is empty -> mirror will be skipped (scan-only mode)" >&2
            echo "MIRROR_DISABLED=1" >> "$GITHUB_ENV"
          else
            echo "MIRROR_DISABLED=0" >> "$GITHUB_ENV"
          fi

      - name: Configure AWS Credentials (OIDC)
        if: env.MIRROR_DISABLED != '1'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure ECR Repository
        if: env.MIRROR_DISABLED != '1'
        run: |
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" >/dev/null 2>&1 || \
            aws ecr create-repository --repository-name "$ECR_REPOSITORY" \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256

      - name: Login to ECR
        if: env.MIRROR_DISABLED != '1'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      # ACCOUNT_IDã®å–å¾—ã¯ä¸è¦ãªã®ã§å‰Šé™¤ (ECRãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‡ºåŠ›ã§ååˆ†ãªãŸã‚)

      - name: Scan & Mirror loop
        id: loop
        env:
          SEVERITY: ${{ github.event.inputs.severity_cutoff || 'HIGH,CRITICAL' }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }} # ECRã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªURLã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æ¸¡ã™
        run: |
          set -euo pipefail
          mkdir -p artifacts sarif
          SUMMARY_FILE=scan-summary.txt
          FAILED_FILE=failed-tags.txt
          touch "$SUMMARY_FILE" "$FAILED_FILE"
          overall_status=0

          for tag in $TAGS; do
            echo "--- Processing tag: $tag ---" | tee -a "$SUMMARY_FILE"
            if ! docker pull "${BASE_IMAGE_REPO}:$tag"; then
              echo "pull_failed $tag" | tee -a "$FAILED_FILE" "$SUMMARY_FILE"
              overall_status=1
              continue
            fi

            echo "Scanning ${BASE_IMAGE_REPO}:$tag"
            # è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œã—ã€é–¾å€¤ã‚’è¶…ãˆãŸã‚‰å¤±æ•—ã•ã›ã‚‹
            if ! trivy image \
              --ignore-unfixed \
              --severity "$SEVERITY" \
              --exit-code 1 \
              --vuln-type os,library \
              --cache-dir "$TRIVY_CACHE_DIR" \
              "${BASE_IMAGE_REPO}:$tag"; then
              # ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ã®è¨˜éŒ²
              echo "scan_failed $tag (vulnerabilities found)" | tee -a "$FAILED_FILE" "$SUMMARY_FILE"
              overall_status=1
            fi

            echo "Generating SARIF for $tag" | tee -a "$SUMMARY_FILE"
            # ã‚¹ã‚­ãƒ£ãƒ³çµæžœã«é–¢ã‚ã‚‰ãšã€å¸¸ã«SARIFãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹
            trivy image \
              --ignore-unfixed \
              --format sarif \
              --output "sarif/trivy-$tag.sarif" \
              --vuln-type os,library \
              --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
              --cache-dir "$TRIVY_CACHE_DIR" \
              "${BASE_IMAGE_REPO}:$tag" || true

            # ã‚¹ã‚­ãƒ£ãƒ³ã«åˆæ ¼ã—ãŸå ´åˆã®ã¿ãƒ—ãƒƒã‚·ãƒ¥å‡¦ç†ã‚’è¡Œã†
            if ! grep -q "scan_failed $tag" "$FAILED_FILE"; then
              # ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ãŒæœ‰åŠ¹ãªå ´åˆ
              if [ "${MIRROR_DISABLED:-0}" = "0" ]; then
                DST="$ECR_REGISTRY/$ECR_REPOSITORY:$tag"
                docker tag "${BASE_IMAGE_REPO}:$tag" "$DST"
                
                echo "Pushing to ECR: $DST"
                if docker push "$DST"; then
                  # ãƒ—ãƒƒã‚·ãƒ¥æˆåŠŸå¾Œã€ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’å–å¾—
                  DIGEST=$(aws ecr describe-images \
                    --repository-name "$ECR_REPOSITORY" \
                    --image-ids imageTag=$tag \
                    --query 'imageDetails[0].imageDigest' \
                    --output text)
                  echo "Tag $tag digest $DIGEST" | tee -a "$SUMMARY_FILE"

                  # Artifactç”¨ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
                  cat > "artifacts/values-image-$tag.yaml" <<EOF
image:
  # ãƒŸãƒ©ãƒ¼æ¸ˆã¿ ECR ãƒªãƒã‚¸ãƒˆãƒª (ã‚¹ã‚­ãƒ£ãƒ³åˆæ ¼)
  repository: $ECR_REGISTRY/$ECR_REPOSITORY
  # ã‚¹ã‚­ãƒ£ãƒ³åˆæ ¼ã‚¿ã‚°
  tag: "$tag"
  # å†ç¾æ€§ç¢ºä¿ã®ãŸã‚ digest ã‚’å„ªå…ˆåˆ©ç”¨
  digest: "$DIGEST"
  pullPolicy: IfNotPresent
EOF
                else
                  # ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ã®è¨˜éŒ²
                  echo "push_failed $tag" | tee -a "$FAILED_FILE" "$SUMMARY_FILE"
                  overall_status=1
                fi
              else
                # ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ç„¡åŠ¹æ™‚ (ã‚¹ã‚­ãƒ£ãƒ³ã®ã¿)
                echo "mirror_skipped $tag (scan-only mode)" | tee -a "$SUMMARY_FILE"
                cat > "artifacts/values-image-$tag.yaml" <<EOF
image:
  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (ECR ãƒŸãƒ©ãƒ¼ç„¡åŠ¹) å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸å‚ç…§
  repository: $BASE_IMAGE_REPO
  tag: "$tag"
  pullPolicy: IfNotPresent
EOF
              fi
            fi
          done

          echo "OVERALL_STATUS=$overall_status" >> "$GITHUB_ENV"

      # ãƒ«ãƒ¼ãƒ—ã§ã¯ãªãã€å…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§sarifãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç›´æŽ¥æŒ‡å®šã—ã¦ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
      - name: Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          # sarif/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®å…¨ .sarif ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          sarif_file: sarif
        
      - name: Upload values artifacts (bundle)
        if: success() # ã‚¸ãƒ§ãƒ–å…¨ä½“ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: values-images
          path: artifacts/

      - name: Summary
        if: always()
        run: |
          echo "## Scan & Mirror Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "Processed tags: $TAGS" >> "$GITHUB_STEP_SUMMARY"
          
          echo "### Scan Digest" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat scan-summary.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          if [ -f failed-tags.txt ] && [ -s failed-tags.txt ]; then
            echo "---" >> "$GITHUB_STEP_SUMMARY"
            echo "### ðŸš¨ Failures" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            cat failed-tags.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ "${OVERALL_STATUS:-0}" != "0" ]; then
            echo "One or more tags failed the process." >&2
            exit 1
          fi
