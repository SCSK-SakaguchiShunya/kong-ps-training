name: scan-kong-gateway

on:
  workflow_dispatch:
    inputs:
      tags:
        description: "スキャンするタグ (カンマ区切り, 例: 3.10,3.11)"
        required: false
        default: "3.11"
      severity_cutoff:
        description: "Trivy の失敗閾値 (例: HIGH,CRITICAL)"
        required: false
        default: "HIGH,CRITICAL"

env:
  BASE_IMAGE_REPO: kong/kong-gateway
  TRIVY_CACHE_DIR: .trivycache
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: kong-gateway-mirror
  TRIVY_VERSION: 0.54.1

permissions:
  contents: read
  security-events: write
  id-token: write

jobs:
  trivy-scan:
    name: Trivy Scan + Mirror
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Normalize tags input
        id: tags
        run: |
          INPUT="${{ github.event.inputs.tags || '3.11' }}"
          LIST=$(echo "$INPUT" | tr ',' '\n' | sed 's/ //g' | grep -v '^$' | sort -u | paste -sd ' ')
          echo "TAGS=$LIST" >> "$GITHUB_ENV"
          echo "Normalized tags: $LIST"

      - name: Setup Trivy Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: trivy-${{ runner.os }}-${{ env.TRIVY_VERSION }}
          restore-keys: |
            trivy-${{ runner.os }}-

      - name: Install Trivy CLI
        run: |
          set -euo pipefail
          echo "Installing Trivy ${TRIVY_VERSION}"
          curl -sSL -o trivy.tgz "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz"
          tar zxvf trivy.tgz trivy >/dev/null 2>&1
          sudo mv trivy /usr/local/bin/
          trivy --version

      - name: Detect AWS credentials method (role or keys)
        id: aws-creds-detect
        run: |
          set -euo pipefail
          role='${{ secrets.AWS_ROLE_TO_ASSUME }}'
          key='${{ secrets.AWS_ACCESS_KEY_ID }}'
          sk='${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          if [ -n "$role" ]; then
            echo "Using AWS OIDC Role assumption" >&2
            echo "CREDS_METHOD=ROLE" >> "$GITHUB_ENV"
            echo "MIRROR_DISABLED=0" >> "$GITHUB_ENV"
          elif [ -n "$key" ] && [ -n "$sk" ]; then
            echo "Using static access keys" >&2
            echo "CREDS_METHOD=KEYS" >> "$GITHUB_ENV"
            echo "MIRROR_DISABLED=0" >> "$GITHUB_ENV"
          else
            echo "No AWS credentials (role nor access keys) -> mirror disabled (scan-only)" >&2
            echo "CREDS_METHOD=NONE" >> "$GITHUB_ENV"
            echo "MIRROR_DISABLED=1" >> "$GITHUB_ENV"
          fi
          # セキュリティ: 値そのものは出力しない

      - name: Configure AWS Credentials (OIDC Role)
        if: env.CREDS_METHOD == 'ROLE'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure AWS Credentials (Access Keys)
        if: env.CREDS_METHOD == 'KEYS'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure ECR Repository
        if: env.MIRROR_DISABLED != '1'
        run: |
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" >/dev/null 2>&1 || \
            aws ecr create-repository --repository-name "$ECR_REPOSITORY" \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256

      - name: Login to ECR
        if: env.MIRROR_DISABLED != '1'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Scan & Mirror loop
        id: loop
        env:
          SEVERITY: ${{ github.event.inputs.severity_cutoff || 'HIGH,CRITICAL' }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          set -euo pipefail
          mkdir -p artifacts sarif
          SUMMARY_FILE=scan-summary.txt
          FAILED_FILE=failed-tags.txt
          touch "$SUMMARY_FILE" "$FAILED_FILE"
          overall_status=0

          for tag in $TAGS; do
            echo "--- Processing tag: $tag ---" | tee -a "$SUMMARY_FILE"
            if ! docker pull "${BASE_IMAGE_REPO}:$tag"; then
              echo "pull_failed $tag" | tee -a "$FAILED_FILE" "$SUMMARY_FILE"
              overall_status=1
              continue
            fi

            echo "Scanning ${BASE_IMAGE_REPO}:$tag"
            if ! trivy image \
              --ignore-unfixed \
              --severity "$SEVERITY" \
              --exit-code 1 \
              --vuln-type os,library \
              --cache-dir "$TRIVY_CACHE_DIR" \
              "${BASE_IMAGE_REPO}:$tag"; then
              echo "scan_failed $tag (vulnerabilities found)" | tee -a "$FAILED_FILE" "$SUMMARY_FILE"
              overall_status=1
            fi

            echo "Generating SARIF for $tag" | tee -a "$SUMMARY_FILE"
            trivy image \
              --ignore-unfixed \
              --format sarif \
              --output "sarif/trivy-$tag.sarif" \
              --vuln-type os,library \
              --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
              --cache-dir "$TRIVY_CACHE_DIR" \
              "${BASE_IMAGE_REPO}:$tag" || true

            # スキャンに失敗したタグはミラーしない (安全側運用)
            if grep -q "scan_failed $tag" "$FAILED_FILE"; then
              echo "Skipping mirror for $tag due to failed scan" | tee -a "$SUMMARY_FILE"
              {
                echo 'image:'
                echo "  repository: $BASE_IMAGE_REPO"
                echo "  tag: \"$tag\""
                echo '  pullPolicy: IfNotPresent'
                echo '  # NOTE: scan failed -> not mirrored to ECR'
              } > "artifacts/values-image-$tag.yaml"
            else
              if [ "${MIRROR_DISABLED:-0}" = "0" ]; then
                DST="$ECR_REGISTRY/$ECR_REPOSITORY:$tag"
                docker tag "${BASE_IMAGE_REPO}:$tag" "$DST"
                echo "Pushing to ECR: $DST"
                if docker push "$DST"; then
                  DIGEST=$(aws ecr describe-images \
                    --repository-name "$ECR_REPOSITORY" \
                    --image-ids imageTag=$tag \
                    --query 'imageDetails[0].imageDigest' \
                    --output text)
                  echo "Tag $tag digest $DIGEST" | tee -a "$SUMMARY_FILE"
                  {
                    echo 'image:'
                    echo "  repository: $ECR_REGISTRY/$ECR_REPOSITORY"
                    echo "  tag: \"$tag\""
                    echo "  digest: \"$DIGEST\""
                    echo '  pullPolicy: IfNotPresent'
                  } > "artifacts/values-image-$tag.yaml"
                else
                  echo "push_failed $tag" | tee -a "$FAILED_FILE" "$SUMMARY_FILE"
                  overall_status=1
                fi
              else
                echo "mirror_skipped $tag (scan-only mode)" | tee -a "$SUMMARY_FILE"
                {
                  echo 'image:'
                  echo "  repository: $BASE_IMAGE_REPO"
                  echo "  tag: \"$tag\""
                  echo '  pullPolicy: IfNotPresent'
                  echo '  # NOTE: scan passed but mirror disabled'
                } > "artifacts/values-image-$tag.yaml"
              fi
            fi
          done

          echo "OVERALL_STATUS=$overall_status" >> "$GITHUB_ENV"

      - name: Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif

      - name: Upload values artifacts (bundle)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: values-images
          path: artifacts/

      - name: Summary
        if: always()
        run: |
          echo "## Scan & Mirror Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "Processed tags: $TAGS" >> "$GITHUB_STEP_SUMMARY"

          echo "### Scan Digest" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat scan-summary.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          if [ -f failed-tags.txt ] && [ -s failed-tags.txt ]; then
            echo "---" >> "$GITHUB_STEP_SUMMARY"
            echo "### 🚨 Failures" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            cat failed-tags.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ "${OVERALL_STATUS:-0}" != "0" ]; then
            echo "One or more tags failed the process." >&2
            exit 1
          fi
